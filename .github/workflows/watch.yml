name: Add or Update Allocators on Merge

on:
  pull_request:
    types:
      - closed
    branches:
      - main

jobs:
  add-or-update-allocators:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    env:
      BACKEND_URL: https://api.staging.allocator.tech

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 

      - name: Set up Git
        run: git fetch origin main

      - name: Add or Update Allocator
        run: |
          failed=0
          failures=""

          echo "üîç Processing changed JSON files..."
          BASE_SHA=$(git merge-base origin/main HEAD)
          CHANGED_FILES=$(git diff --name-only HEAD^1 HEAD | grep '^Allocators/.*\.json$' || true)

          if [[ -z "$CHANGED_FILES" ]]; then
            echo "No relevant changed files in Allocators/"
            exit 0
          fi

          for file in $CHANGED_FILES; do
            echo ""
            echo "Adding/Updating: $file"
            JSON_BODY="{\"files_changed\":[\"$file\"]}"

            if curl -f --header "Content-Type: application/json" \
                     --request POST \
                     --data "$JSON_BODY" \
                     "${BACKEND_URL}/allocator/create"; then
              echo "Success for $file"
            else
              echo "::error file=$file,title=Backend failed::Failed to add/update allocator for $file"
              failures="${failures}\n- $file"
              failed=1
            fi
          done

          if [[ "$failed" -eq 1 ]]; then
            echo ""
            echo -e "::error title=One or more backend calls failed::Failed for the following files:\n$failures"
            exit 1
          fi
